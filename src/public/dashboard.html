<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - Mentor Scoring AI</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <!-- MediaPipe Libraries -->
    <script
      src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"
      crossorigin="anonymous"
    ></script>
    <style>
      /* Copy ALL CSS styles from your original index.html */
      /* I'm including the complete CSS from your working index.html */

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Poppins", sans-serif;
        background: linear-gradient(135deg, #e8f1f2 0%, #d4e4e7 100%);
        color: #0a3d62;
        -webkit-font-smoothing: antialiased;
        min-height: 100vh;
      }

      :root {
        --primary: #0a3d62;
        --secondary: #1b98e0;
        --accent: #f6b93b;
        --bg: #e8f1f2;
        --glass-bg: rgba(255, 255, 255, 0.85);
        --glass-border: rgba(255, 255, 255, 0.4);
        --success: #2ecc71;
        --danger: #e74c3c;
        --warning: #e67e22;
      }

      .glass-card {
        background: var(--glass-bg);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border-radius: 16px;
        border: 1px solid var(--glass-border);
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
        padding: 2rem;
        transition: transform 0.3s ease;
      }

      .glass-card:hover {
        transform: translateY(-2px);
      }

      .btn {
        padding: 0.8rem 1.5rem;
        border-radius: 50px;
        border: none;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-family: "Poppins", sans-serif;
        text-decoration: none;
        font-size: 1rem;
      }

      .btn-primary {
        background: var(--primary);
        color: white;
        box-shadow: 0 4px 15px rgba(10, 61, 98, 0.3);
      }

      .btn-primary:hover {
        background: var(--secondary);
        transform: translateY(-2px);
      }

      .btn-outline {
        background: transparent;
        border: 2px solid var(--primary);
        color: var(--primary);
      }

      .btn-outline:hover {
        background: var(--primary);
        color: white;
      }

      .nav-link {
        cursor: pointer;
        font-weight: 500;
        color: var(--primary);
        opacity: 0.7;
        transition: opacity 0.2s;
        padding: 0.5rem;
        text-decoration: none;
        font-size: 0.9rem;
      }

      .nav-link:hover,
      .nav-link.active {
        opacity: 1;
        color: var(--secondary);
      }

      .nav-header {
        font-size: 1.3rem;
        font-weight: 700;
        color: var(--primary);
        display: flex;
        align-items: center;
        gap: 5px;
        cursor: pointer;
      }

      .nav-header span {
        font-size: 1.7rem;
      }

      .nav-upload-btn {
        font-size: 0.75rem !important;
        padding: 0.4rem 0.8rem !important;
        min-width: 90px;
      }

      .hamburger-menu {
        display: none;
        flex-direction: column;
        cursor: pointer;
        padding: 0.5rem;
      }

      .hamburger-menu span {
        width: 25px;
        height: 3px;
        background: var(--primary);
        margin: 3px 0;
        transition: 0.3s;
        border-radius: 2px;
      }

      .mobile-nav {
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        flex-direction: column;
        padding: 1rem;
        border-bottom: 1px solid var(--glass-border);
      }

      .mobile-nav.active {
        display: flex;
      }

      .form-input {
        width: 100%;
        padding: 12px 15px;
        margin: 8px 0 20px 0;
        display: inline-block;
        border: 1px solid #ccc;
        border-radius: 8px;
        box-sizing: border-box;
        font-family: "Poppins", sans-serif;
        background: rgba(255, 255, 255, 0.9);
      }

      .form-input:focus {
        outline: none;
        border-color: var(--secondary);
        box-shadow: 0 0 0 3px rgba(27, 152, 224, 0.2);
      }

      .scanner-line {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 4px;
        background: var(--accent);
        box-shadow: 0 0 10px var(--accent);
        animation: scan 2s linear infinite;
        z-index: 10;
      }

      @keyframes scan {
        0% {
          top: 0%;
          opacity: 0;
        }
        10% {
          opacity: 1;
        }
        90% {
          opacity: 1;
        }
        100% {
          top: 100%;
          opacity: 0;
        }
      }

      .anim-float {
        animation: float 6s ease-in-out infinite;
      }

      @keyframes float {
        0% {
          transform: translateY(0px);
        }
        50% {
          transform: translateY(-20px);
        }
        100% {
          transform: translateY(0px);
        }
      }

      .bar-fill {
        transition: width 1s ease-out;
      }

      .donut-circle {
        transition: stroke-dashoffset 1.5s ease-in-out;
      }

      .wave-bar {
        width: 3px;
        background: var(--secondary);
        border-radius: 2px;
        animation: wave 1.2s ease-in-out infinite;
      }

      @keyframes wave {
        0%,
        100% {
          transform: scaleY(0.5);
        }
        50% {
          transform: scaleY(1.5);
        }
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 20px;
      }

      nav {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 2rem;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        position: sticky;
        top: 0;
        z-index: 100;
        border-bottom: 1px solid var(--glass-border);
      }

      .nav-links-container {
        display: flex;
        gap: 1.5rem;
      }

      .desktop-user-info {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .desktop-user-info > div {
        line-height: 1.2;
      }

      main {
        flex: 1;
        min-height: calc(100vh - 80px);
      }

      footer {
        text-align: center;
        padding: 2rem;
        margin-top: 3rem;
        color: var(--primary);
        opacity: 0.8;
      }

      .grid-2-col {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
      }

      .grid-auto-fit {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 1rem;
      }

      .body-language-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-top: 1rem;
      }

      .body-metric-card {
        background: rgba(255, 255, 255, 0.7);
        padding: 1.5rem;
        border-radius: 12px;
        text-align: center;
        border-left: 4px solid var(--secondary);
      }

      .metric-value {
        font-size: 2.5rem;
        font-weight: bold;
        color: var(--primary);
        margin: 0.5rem 0;
      }

      .metric-label {
        font-size: 0.9rem;
        color: #666;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .conceptual-gap-card {
        background: #fff3cd;
        border-radius: 8px;
        border-left: 4px solid var(--warning);
        margin-bottom: 1rem;
        overflow: hidden;
      }

      .gap-header {
        background: var(--warning);
        color: white;
        padding: 0.8rem 1rem;
        font-weight: 600;
      }

      .gap-content {
        padding: 1rem;
      }

      @media (max-width: 1000px) {
        .nav-links-container {
          display: none;
        }

        .hamburger-menu {
          display: flex;
        }

        .desktop-user-info {
          display: none;
        }

        .grid-2-col {
          grid-template-columns: 1fr;
          gap: 1rem;
        }

        .dashboard-layout {
          grid-template-columns: 1fr !important;
        }
      }

      @media (max-width: 768px) {
        .glass-card {
          padding: 1.5rem;
        }

        nav {
          padding: 1rem;
        }

        .container {
          padding: 0 15px;
        }

        .body-language-grid {
          grid-template-columns: 1fr;
        }

        .grid-auto-fit {
          grid-template-columns: 1fr;
        }

        h1 {
          font-size: 2.5rem !important;
        }
      }

      @media (max-width: 480px) {
        .glass-card {
          padding: 1rem;
        }

        .btn {
          padding: 0.6rem 1.2rem;
          font-size: 0.9rem;
        }

        .metric-value {
          font-size: 2rem;
        }
      }

      .dashboard-layout {
        display: grid;
        grid-template-columns: 300px 1fr;
        gap: 2rem;
      }

      @media (max-width: 1000px) {
        .dashboard-layout {
          grid-template-columns: 1fr;
        }
      }

      @media (max-width: 768px) {
        #video-modal video {
          max-width: 95vw !important;
          max-height: 50vh !important;
        }

        #audio-modal > div {
          padding: 1rem !important;
          width: 95% !important;
        }

        .close-btn-mobile {
          top: 10px !important;
          right: 10px !important;
          width: 35px !important;
          height: 35px !important;
          font-size: 1.2rem !important;
        }
      }

      body.modal-open {
        overflow: hidden;
        position: fixed;
        width: 100%;
        height: 100%;
      }

      .bar-fill {
        transition: width 1s cubic-bezier(0.34, 1.56, 0.64, 1);
      }

      .score-excellent {
        color: var(--success);
      }
      .score-good {
        color: var(--warning);
      }
      .score-poor {
        color: var(--danger);
      }

      .metric-tooltip {
        position: relative;
        cursor: help;
      }

      .metric-tooltip:hover::after {
        content: attr(data-tooltip);
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 0.7rem;
        white-space: nowrap;
        z-index: 10;
      }

      #output-canvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1;
      }

      #input-video {
        position: relative;
        z-index: 0;
      }

      .analysis-progress {
        width: 100%;
        height: 4px;
        background: linear-gradient(
          90deg,
          var(--secondary) 0%,
          var(--accent) 100%
        );
        border-radius: 2px;
        margin: 10px 0;
        overflow: hidden;
      }

      .analysis-progress::after {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.8),
          transparent
        );
        animation: shimmer 2s infinite;
      }

      @keyframes shimmer {
        100% {
          left: 100%;
        }
      }

      .metric-indicator {
        display: flex;
        align-items: center;
        gap: 10px;
        margin: 5px 0;
      }

      .metric-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: var(--secondary);
      }

      .metric-dot.excellent {
        background: var(--success);
      }
      .metric-dot.good {
        background: var(--warning);
      }
      .metric-dot.poor {
        background: var(--danger);
      }

      /* Auth-specific additions */
      .user-info {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--secondary), var(--primary));
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 1.2rem;
      }

      .user-details {
        text-align: right;
      }

      .user-name {
        font-weight: 600;
        font-size: 0.9rem;
      }

      .user-email {
        font-size: 0.8rem;
        color: #666;
      }

      .logout-btn {
        margin-left: 10px;
        padding: 0.6rem 1.2rem;
        font-size: 0.8rem;
      }

      /* Dashboard specific styles */
      .welcome-section {
        text-align: center;
        margin-bottom: 3rem;
        padding: 2rem;
      }

      .welcome-title {
        font-size: 2.5rem;
        margin-bottom: 1rem;
        background: linear-gradient(to right, var(--primary), var(--secondary));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }

      .welcome-subtitle {
        color: #666;
        font-size: 1.1rem;
        max-width: 600px;
        margin: 0 auto;
      }

      .quick-actions {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 3rem;
      }

      .action-card {
        background: white;
        padding: 2rem;
        border-radius: 16px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 2px solid transparent;
      }

      .action-card:hover {
        transform: translateY(-5px);
        border-color: var(--secondary);
        box-shadow: 0 10px 30px rgba(27, 152, 224, 0.2);
      }

      .action-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
      }

      .action-title {
        font-size: 1.3rem;
        margin-bottom: 0.5rem;
        color: var(--primary);
      }

      .action-desc {
        color: #666;
        font-size: 0.9rem;
      }

      .recent-sessions {
        margin-bottom: 3rem;
      }

      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
      }

      .section-title {
        font-size: 1.5rem;
        color: var(--primary);
      }

      .session-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
      }

      .session-card {
        background: white;
        padding: 1.5rem;
        border-radius: 12px;
        border-left: 4px solid var(--secondary);
      }

      .session-meta {
        display: flex;
        justify-content: space-between;
        margin-bottom: 1rem;
        font-size: 0.9rem;
        color: #666;
      }

      .session-score {
        font-size: 2rem;
        font-weight: bold;
        color: var(--primary);
        margin-bottom: 0.5rem;
      }

      .session-score.excellent {
        color: var(--success);
      }
      .session-score.good {
        color: var(--warning);
      }
      .session-score.poor {
        color: var(--danger);
      }

      .session-actions {
        display: flex;
        gap: 10px;
        margin-top: 1rem;
      }

      .empty-state {
        text-align: center;
        padding: 3rem;
        color: #666;
      }

      .empty-state-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
        opacity: 0.5;
      }

      /* Responsive for dashboard */
      @media (max-width: 768px) {
        .user-details {
          display: none;
        }

        .logout-btn {
          margin-left: 5px;
          padding: 0.5rem 1rem;
        }

        .welcome-title {
          font-size: 2rem;
        }

        .quick-actions {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div id="app"></div>

    <!-- API Service Script -->
    <script>
      // Enhanced API Service with Authentication
      class ApiService {
        constructor() {
          this.baseURL =
            window.location.hostname === "localhost"
              ? "http://localhost:5000"
              : "https://mentor-scoring-ai.onrender.com";

          this.token = localStorage.getItem("token");
          this.user = JSON.parse(localStorage.getItem("user") || "{}");
          this.institution = JSON.parse(
            localStorage.getItem("institution") || "null"
          );
        }

        async request(endpoint, options = {}) {
          try {
            const headers = {
              "Content-Type": "application/json",
              ...options.headers,
            };

            // Add auth token if available
            if (this.token) {
              headers["Authorization"] = `Bearer ${this.token}`;
            }

            console.log(`API Request: ${this.baseURL}${endpoint}`);

            const response = await fetch(`${this.baseURL}${endpoint}`, {
              headers,
              ...options,
            });

            // Handle unauthorized (401) - redirect to login
            if (response.status === 401) {
              this.logout();
              throw new Error("Session expired. Please login again.");
            }

            if (!response.ok) {
              console.error(
                `API Error ${response.status}: ${response.statusText}`
              );
              throw new Error(`HTTP error! status: ${response.status}`);
            }

            return await response.json();
          } catch (error) {
            console.error("API request failed:", error);
            throw error;
          }
        }

        // Authentication methods
        logout() {
          localStorage.removeItem("token");
          localStorage.removeItem("user");
          localStorage.removeItem("institution");
          window.location.href = "login.html";
        }

        isLoggedIn() {
          return !!this.token;
        }

        getUserType() {
          return this.user?.userType || "individual";
        }

        // Session Management
        async createSession(userDetails) {
          const sessionData = {
            ...userDetails,
            userId: this.user?.id,
            institutionCode:
              this.user?.institutionCode || userDetails.institutionCode,
          };

          return this.request("/api/session/create", {
            method: "POST",
            body: JSON.stringify(sessionData),
          });
        }

        async uploadVideo(sessionId, file) {
          const formData = new FormData();
          formData.append("video", file);

          const response = await fetch(
            `${this.baseURL}/api/session/${sessionId}/upload`,
            {
              method: "POST",
              body: formData,
              headers: this.token
                ? {
                    Authorization: `Bearer ${this.token}`,
                  }
                : {},
            }
          );

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          return await response.json();
        }

        async extractAudio(sessionId) {
          return this.request(`/api/session/${sessionId}/extract-audio`, {
            method: "POST",
          });
        }

        async generateTranscript(sessionId) {
          return this.request(`/api/session/${sessionId}/transcript`, {
            method: "POST",
          });
        }

        async saveBodyMetrics(sessionId, bodyMetrics) {
          return this.request(`/api/session/${sessionId}/body-metrics`, {
            method: "POST",
            body: JSON.stringify(bodyMetrics),
          });
        }

        async scoreSession(sessionId) {
          return this.request(`/api/session/score/${sessionId}`, {
            method: "POST",
          });
        }

        // User sessions
        async getUserSessions() {
          try {
            const response = await this.request("/api/institution/my-sessions");
            return response;
          } catch (error) {
            console.log("Could not load user sessions:", error.message);
            return { sessions: [] };
          }
        }

        // Get current user info
        async getCurrentUser() {
          try {
            const response = await this.request("/api/auth/me");
            return response;
          } catch (error) {
            console.log("Could not load user info:", error.message);
            return null;
          }
        }

        // Additional methods
        async login(email, password) {
          const response = await this.request("/api/auth/login", {
            method: "POST",
            body: JSON.stringify({ email, password }),
          });

          if (response.token) {
            this.token = response.token;
            this.user = response.user;
            this.institution = response.institution;
            localStorage.setItem("token", this.token);
            localStorage.setItem("user", JSON.stringify(this.user));
            localStorage.setItem(
              "institution",
              JSON.stringify(this.institution)
            );
          }

          return response;
        }
        async saveSessionToDashboard(sessionData) {
          try {
            let userSessions = JSON.parse(
              localStorage.getItem("userSessions") || "[]"
            );

            // Check if session already exists
            const existingIndex = userSessions.findIndex(
              (s) => s.id === sessionData.id
            );

            if (existingIndex >= 0) {
              // Update existing session
              userSessions[existingIndex] = {
                ...userSessions[existingIndex],
                ...sessionData,
                updatedAt: new Date().toISOString(),
              };
            } else {
              // Add new session
              userSessions.push({
                ...sessionData,
                createdAt: new Date().toISOString(),
              });
            }

            localStorage.setItem("userSessions", JSON.stringify(userSessions));
            return true;
          } catch (error) {
            console.error("Failed to save session:", error);
            return false;
          }
        }
        async getUserSessions() {
          try {
            const userSessions = JSON.parse(
              localStorage.getItem("userSessions") || "[]"
            );
            return { sessions: userSessions };
          } catch (error) {
            console.error("Failed to get sessions:", error);
            return { sessions: [] };
          }
        }
      }

      // Create global instance
      window.apiService = new ApiService();
    </script>

    <script>
      // Mock Data (fallback if API fails)
      const MOCK_BACKEND_RESPONSE = {
        message: "Scoring successful",
        finalReport: {
          sessionId: "demo-session-123",
          metadata: {
            mentorName: "Demo User",
            role: "Python teacher",
            institutionCode: "DEMO-INST",
            timestamp: new Date().toISOString(),
          },
          transcript: "hello today I'm going to explain about operators...",
          audioMetrics: {
            totalWords: 35,
            totalSentences: 1,
            fillerWords: 4,
            wordsPerMin: 72,
            pauseCount: 0,
            sentenceComplexityScore: 5,
            pronunciationScore: 10,
            speakingStabilityScore: 10,
          },
          bodyLanguageMetrics: {
            eyeContact: 7.2,
            posture: 6.8,
            gestures: 5.4,
            facialExpressiveness: 6.1,
            movement: 4.9,
            overallBodyLanguage: 6.1,
          },
          rubric: {
            dimensions: [
              {
                name: "Concept Clarity",
                weight: 0.25,
                description:
                  "How clearly the teacher explains Python concepts.",
                examplesOfGood:
                  "Uses simple definitions; demonstrates with live code snippets.",
                examplesOfBad: "Provides vague or ambiguous explanations.",
              },
              {
                name: "Delivery & Communication",
                weight: 0.25,
                description:
                  "Voice clarity, pacing, energy, and ability to convey syntax effectively.",
                examplesOfGood:
                  "Clear articulation of code; varied tone to emphasize key points.",
                examplesOfBad:
                  "Monotone voice; speaks too fast causing missed points.",
              },
              {
                name: "Content Structure",
                weight: 0.2,
                description: "Logical organization of lessons.",
                examplesOfGood:
                  "Starts with problem statement, walks through solution step-by-step.",
                examplesOfBad: "Randomly shows code snippets without context.",
              },
              {
                name: "Student Engagement",
                weight: 0.15,
                description: "Interaction with learners.",
                examplesOfGood:
                  "Poses coding challenges, asks learners to predict output.",
                examplesOfBad: "One-way lecture; never invites questions.",
              },
              {
                name: "Accuracy",
                weight: 0.15,
                description: "Correctness of syntax and best practices.",
                examplesOfGood:
                  "Demonstrates correct syntax; follows conventions.",
                examplesOfBad:
                  "Shows code with syntax errors; misstates behavior.",
              },
            ],
          },
          scoreReport: {
            scores: [
              {
                dimension: "Concept Clarity",
                score: 2,
                justification:
                  "The teacher provides a vague, off-topic explanation.",
              },
              {
                dimension: "Delivery & Communication",
                score: 3,
                justification:
                  'Frequent filler words ("like", "okay", "yeah") and a monotonous pace.',
              },
              {
                dimension: "Content Structure",
                score: 2,
                justification:
                  "There is no logical progression‚Äîno introduction, no clear example.",
              },
              {
                dimension: "Student Engagement",
                score: 1,
                justification:
                  "The segment is a one-way monologue with no prompts or questions.",
              },
              {
                dimension: "Accuracy",
                score: 2,
                justification:
                  "The teacher incorrectly frames the discussion around C operators.",
              },
            ],
            finalScore: 2.1,
            improvementPlan: {
              issuesDetected: [
                "Excessive filler words and monotone delivery",
                "Incorrect language context (C vs Python)",
                "Absence of lesson structure",
                "No interactive engagement",
                "Missing key Python operator concepts",
              ],
              correctedVersion:
                "Welcome to the Python operators lesson. First, we'll define what an operator is...",
              teachingStrategy: [
                "Begin with a clear learning objective and agenda.",
                "Introduce each operator category with concise definitions and live code demos.",
                "Use visual slides that highlight syntax and precedence tables.",
                "Summarize key takeaways after each section.",
              ],
              engagementSuggestions: [
                "Ask learners to predict the output of a short expression before running it.",
                'Include a quick poll: "Which operator has higher precedence, * or +?"',
                "Provide a short hands-on exercise where students modify an expression.",
                "Encourage learners to share any surprising behavior they encounter.",
              ],
              deliveryGuidance: [
                'Eliminate filler words by pausing briefly instead of saying "like" or "okay".',
                "Vary vocal tone to emphasize important syntax.",
                "Maintain a moderate speaking rate (~120 wpm) to allow code to be read.",
                "Use deliberate eye contact or camera framing to convey confidence.",
              ],
            },
            feedbackAudio: "uploads/tts/demo_mentor_feedback.mp3",
          },
          evidenceClips: [],
        },
      };

      // Import all the components from your original index.html
      // These are the key components you need:

      // Component: Metric Bar
      function MetricBar(label, value, max, inverse = false) {
        const numValue = Number(value) || 0;
        let effectiveMax = max;
        let scoreLabel = "";

        if (label === "WPM") {
          effectiveMax = 200;
          scoreLabel = " wpm";
        } else if (label === "Filler Words") {
          effectiveMax = 20;
          scoreLabel = "";
        } else if (label === "Pause Count") {
          effectiveMax = 10;
          scoreLabel = "";
        } else if (label.includes("Score")) {
          effectiveMax = 5;
          scoreLabel = "/5";
        } else {
          effectiveMax = max || 10;
        }

        let pct = (numValue / effectiveMax) * 100;
        if (inverse) {
          pct = 100 - (numValue / effectiveMax) * 100;
          if (pct < 0) pct = 0;
        }
        if (pct > 100) pct = 100;

        let color = "var(--secondary)";
        if (label.includes("Score")) {
          if (numValue < 2.5) color = "var(--danger)";
          else if (numValue < 3.5) color = "var(--warning)";
          else color = "var(--success)";
        } else if (label === "WPM") {
          if (numValue < 100 || numValue > 180) color = "var(--danger)";
          else if (numValue < 120 || numValue > 160) color = "var(--warning)";
          else color = "var(--success)";
        } else if (label === "Filler Words" || label === "Pause Count") {
          if (numValue > 10) color = "var(--danger)";
          else if (numValue > 5) color = "var(--warning)";
          else color = "var(--success)";
        } else {
          if (pct < 30) color = "var(--danger)";
          else if (pct < 60) color = "var(--warning)";
          else color = "var(--success)";
        }

        let displayValue;
        if (label === "WPM") {
          displayValue = Math.round(numValue);
        } else if (label.includes("Score")) {
          displayValue = numValue.toFixed(1);
        } else {
          displayValue = Math.round(numValue);
        }

        return `
                                        <div style="margin-bottom:15px">
                                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px; font-size:0.85rem">
                                                <span style="font-weight:500">${label}</span>
                                                <strong style="color: var(--primary)">${displayValue}${scoreLabel}</strong>
                                            </div>
                                            <div style="width: 100%; height: 8px; background: rgba(0,0,0,0.1); border-radius: 4px; overflow: hidden">
                                                <div class="bar-fill" style="width: ${pct}%; height: 100%; background: ${color}; border-radius: 4px; transition: width 1s ease"></div>
                                            </div>
                                        </div>
                                    `;
      }

      // Component: Score Card
      function ScoreCard(finalScore) {
        const size = 180;
        const strokeWidth = 15;
        const radius = (size - strokeWidth) / 2;
        const circumference = 2 * Math.PI * radius;

        const displayScore = finalScore.toFixed(2);
        const offset = circumference - (finalScore / 5) * circumference;

        let scoreColor = "var(--danger)";
        if (finalScore > 2.5) scoreColor = "var(--warning)";
        if (finalScore > 3.5) scoreColor = "var(--success)";

        return `
                                        <div class="glass-card" style="text-align: center; position: relative">
                                            <h3>Final Score</h3>
                                            <div style="position: relative; width: ${size}px; height: ${size}px; margin: 1rem auto">
                                                <svg width="${size}" height="${size}" style="transform: rotate(-90deg)">
                                                    <circle stroke="#e6e6e6" stroke-width="${strokeWidth}" fill="transparent" r="${radius}" cx="${
          size / 2
        }" cy="${size / 2}" />
                                                    <circle
                                                        stroke="${scoreColor}"
                                                        stroke-width="${strokeWidth}"
                                                        stroke-dasharray="${circumference} ${circumference}"
                                                        stroke-dashoffset="${offset}"
                                                        stroke-linecap="round"
                                                        fill="transparent"
                                                        r="${radius}" cx="${
          size / 2
        }" cy="${size / 2}"
                                                        class="donut-circle"
                                                    />
                                                </svg>
                                                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 3rem; font-weight: bold; color: var(--primary)">
                                                    ${displayScore}
                                                </div>
                                            </div>
                                            <span style="background: ${scoreColor}; color: white; padding: 4px 10px; border-radius: 12px; font-size: 0.8rem; font-weight: bold">
                                                ${
                                                  finalScore < 2.5
                                                    ? "Needs Improvement"
                                                    : finalScore < 3.5
                                                    ? "Satisfactory"
                                                    : "Excellent"
                                                }
                                            </span>
                                            <div style="font-size: 0.8rem; color: #666; margin-top: 0.5rem">
                                                Scale: 0-5
                                            </div>
                                        </div>
                                    `;
      }

      // Main Application
      const app = {
        currentPage: "dashboard",
        userDetails: null,
        analysisData: null,
        mobileNavOpen: false,
        currentSessionId: null,
        currentFile: null,
        userSessions: [],
        bodyMetrics: null,
        roleConfirmed: false,
        selectedRole: null,

        init() {
          // Check authentication
          if (!apiService.isLoggedIn()) {
            window.location.href = "login.html";
            return;
          }

          // Load user details
          this.userDetails = {
            institutionCode: apiService.user?.institutionCode || "",
            mentorName: apiService.user?.name || "User",
            role: "Teacher",
          };

          // Load user sessions
          this.loadUserSessions();

          this.render();
          this.setupEventListeners();
        },

        async loadUserSessions() {
          try {
            const response = await apiService.getUserSessions();
            this.userSessions = response.sessions || [];
          } catch (error) {
            console.log("Using mock sessions data");
            this.userSessions = [
              {
                id: "1",
                mentorName: "Python Basics",
                role: "Python Instructor",
                score: 4.2,
                date: new Date(Date.now() - 86400000).toISOString(),
                hasClips: true,
                hasFeedbackAudio: true,
              },
              {
                id: "2",
                mentorName: "JavaScript Functions",
                role: "Web Development",
                score: 3.8,
                date: new Date(Date.now() - 172800000).toISOString(),
                hasClips: false,
                hasFeedbackAudio: true,
              },
            ];
          }
        },

        setupEventListeners() {
          document.addEventListener("submit", (e) => {
            if (e.target.id === "onboarding-form") {
              e.preventDefault();
              this.handleOnboardingSubmit(e);
            }
          });

          document.addEventListener("change", (e) => {
            if (e.target.id === "v-upload") {
              this.currentFile = e.target.files[0];
              this.handleFileUpload(this.currentFile);
            }
            if (e.target.id === "v-upload") {
              this.currentFile = e.target.files[0];
              this.handleFileUpload(this.currentFile);
            }
          });
        },

        toggleMobileNav() {
          this.mobileNavOpen = !this.mobileNavOpen;
          this.render();
        },

        // Navigation Component
        Navigation(currentPage) {
          const navItems = this.userDetails
            ? ["Dashboard", "Upload", "Sessions", "Profile"]
            : [];

          const getRouteKey = (item) => item.toLowerCase().replace(" ", "");

          const user = apiService.user;
          const userInitial = user?.name?.charAt(0).toUpperCase() || "U";

          return `
                                            <nav>
                                                <div class="nav-header" onclick="app.setPage('dashboard')">
                                                    <span>üéì</span> Mentor Scoring AI
                                                </div>

                                                <div class="nav-links-container">
                                                    ${navItems
                                                      .map(
                                                        (item) => `
                                                        <a class="nav-link ${
                                                          currentPage ===
                                                          getRouteKey(item)
                                                            ? "active"
                                                            : ""
                                                        }"
                                                            onclick="app.setPage('${getRouteKey(
                                                              item
                                                            )}')">
                                                            ${item}
                                                        </a>
                                                    `
                                                      )
                                                      .join("")}
                                                </div>

                                                <div class="hamburger-menu" onclick="app.toggleMobileNav()">
                                                    <span></span>
                                                    <span></span>
                                                    <span></span>
                                                </div>

                                                <div class="desktop-user-info">
                                                    <div class="user-info">
                                                        <div class="user-details">
                                                            <div class="user-name">${
                                                              user?.name ||
                                                              "User"
                                                            }</div>
                                                            <div class="user-email">${
                                                              user?.email || ""
                                                            }</div>
                                                        </div>
                                                        <div class="user-avatar">${userInitial}</div>
                                                        <button class="btn btn-outline logout-btn" onclick="apiService.logout()">
                                                            Logout
                                                        </button>
                                                    </div>
                                                </div>

                                                <div class="mobile-nav" id="mobileNav" style="display: ${
                                                  this.mobileNavOpen
                                                    ? "flex"
                                                    : "none"
                                                }">
                                                    ${navItems
                                                      .map(
                                                        (item) => `
                                                        <a class="nav-link ${
                                                          currentPage ===
                                                          getRouteKey(item)
                                                            ? "active"
                                                            : ""
                                                        }"
                                                            onclick="app.setPage('${getRouteKey(
                                                              item
                                                            )}'); app.toggleMobileNav()">
                                                            ${item}
                                                        </a>
                                                    `
                                                      )
                                                      .join("")}
                                                    <div style="padding: 1rem; border-top: 1px solid var(--glass-border); margin-top: 1rem;">
                                                        <div style="font-size: 0.9rem; color: var(--primary); margin-bottom: 0.5rem;">
                                                            <strong>${
                                                              user?.name ||
                                                              "User"
                                                            }</strong><br/>
                                                            ${user?.email || ""}
                                                        </div>
                                                        <button class="btn btn-primary" onclick="app.setPage('upload'); app.toggleMobileNav()" style="width: 100%; font-size: 0.8rem; padding: 0.5rem">
                                                            New Upload
                                                        </button>
                                                        <button class="btn btn-outline" onclick="apiService.logout()" style="width: 100%; margin-top: 0.5rem; font-size: 0.8rem; padding: 0.5rem">
                                                            Logout
                                                        </button>
                                                    </div>
                                                </div>
                                            </nav>
                                        `;
        },

        // Dashboard Page Component
        DashboardPage() {
          const userName = apiService.user?.name || "Teacher";

          return `
                                            <main>
                                                <div class="container">
                                                    <div class="welcome-section">
                                                        <h1 class="welcome-title">Welcome back, ${userName}! üëã</h1>
                                                        <p class="welcome-subtitle">
                                                            Ready to improve your teaching skills? Upload a session or review your previous evaluations.
                                                            ${
                                                              apiService.user
                                                                ?.institutionCode
                                                                ? `<br>Institution: <strong>${apiService.user.institutionCode}</strong>`
                                                                : ""
                                                            }
                                                        </p>
                                                    </div>

                                                    <div class="quick-actions">
                                                        <div class="action-card" onclick="app.setPage('upload')">
                                                            <div class="action-icon">üé•</div>
                                                            <h3 class="action-title">Upload New Session</h3>
                                                            <p class="action-desc">Upload a teaching video for AI analysis and feedback</p>
                                                        </div>

                                                        <div class="action-card" onclick="app.viewTutorial()">
                                                            <div class="action-icon">üìö</div>
                                                            <h3 class="action-title">View Tutorial</h3>
                                                            <p class="action-desc">Learn how to get the most out of Mentor Scoring AI</p>
                                                        </div>

                                                        <div class="action-card" onclick="app.setPage('sessions')">
                                                            <div class="action-icon">üìä</div>
                                                            <h3 class="action-title">View Analytics</h3>
                                                            <p class="action-desc">See your progress and improvement over time</p>
                                                        </div>

                                                        ${
                                                          apiService.user
                                                            ?.userType ===
                                                          "institution_admin"
                                                            ? `
                                                        <div class="action-card" onclick="window.location.href='institution-dashboard.html'">
                                                            <div class="action-icon">üè´</div>
                                                            <h3 class="action-title">Institution Dashboard</h3>
                                                            <p class="action-desc">Manage teachers and view institution analytics</p>
                                                        </div>
                                                        `
                                                            : ""
                                                        }
                                                    </div>

                                                    <div class="recent-sessions">
                                                        <div class="section-header">
                                                            <h2 class="section-title">Recent Sessions</h2>
                                                            <button class="btn btn-outline" onclick="app.setPage('sessions')">
                                                                View All
                                                            </button>
                                                        </div>

                                                        ${
                                                          this.userSessions
                                                            .length > 0
                                                            ? `
                                                        <div class="session-grid">
                                                            ${this.userSessions
                                                              .slice(0, 3)
                                                              .map(
                                                                (session) => {
                                                                  let scoreClass =
                                                                    "good";
                                                                  if (
                                                                    session.score >=
                                                                    4
                                                                  )
                                                                    scoreClass =
                                                                      "excellent";
                                                                  if (
                                                                    session.score <
                                                                    2.5
                                                                  )
                                                                    scoreClass =
                                                                      "poor";

                                                                  return `
                                                                <div class="session-card">
                                                                    <div class="session-meta">
                                                                        <span>${
                                                                          session.role
                                                                        }</span>
                                                                        <span>${new Date(
                                                                          session.date
                                                                        ).toLocaleDateString()}</span>
                                                                    </div>
                                                                    <h3 style="margin-bottom: 0.5rem; color: var(--primary);">${
                                                                      session.mentorName
                                                                    }</h3>
                                                                    <div class="session-score ${scoreClass}">${
                                                                    session.score
                                                                  }/5</div>
                                                                    <div class="session-actions">
                                                                        <button class="btn btn-outline" style="padding: 0.5rem 1rem; font-size: 0.8rem;" onclick="app.viewSession('${
                                                                          session.id
                                                                        }')">
                                                                            View Details
                                                                        </button>
                                                                        ${
                                                                          session.hasClips
                                                                            ? `
                                                                        <button class="btn btn-outline" style="padding: 0.5rem 1rem; font-size: 0.8rem;" onclick="app.viewClips('${session.id}')">
                                                                            Evidence Clips
                                                                        </button>
                                                                        `
                                                                            : ""
                                                                        }
                                                                    </div>
                                                                </div>
                                                              `;
                                                                }
                                                              )
                                                              .join("")}
                                                        </div>
                                                        `
                                                            : `
                                                        <div class="empty-state">
                                                            <div class="empty-state-icon">üìπ</div>
                                                            <h3>No sessions yet</h3>
                                                            <p>Upload your first teaching session to get AI feedback</p>
                                                            <button class="btn btn-primary" onclick="app.setPage('upload')" style="margin-top: 1rem;">
                                                                Upload Your First Session
                                                            </button>
                                                        </div>
                                                        `
                                                        }
                                                    </div>

                                                    <div class="glass-card" style="margin-top: 3rem;">
                                                        <h3 style="color: var(--primary); margin-bottom: 1rem;">üí° Quick Tips for Better Scores</h3>
                                                        <ul style="padding-left: 1.5rem; color: #555; line-height: 1.6;">
                                                            <li>Speak at a moderate pace (120-160 words per minute)</li>
                                                            <li>Minimize filler words like "um", "like", "you know"</li>
                                                            <li>Maintain eye contact with the camera/audience</li>
                                                            <li>Use gestures to emphasize key points</li>
                                                            <li>Structure your lesson with clear objectives</li>
                                                            <li>Include interactive elements and questions</li>
                                                        </ul>
                                                    </div>
                                                </div>
                                            </main>
                                        `;
        },

        UploadPage() {
          return `
              <main>
                <div class="container" style="max-width: 700px; margin: 3rem auto;">
                  <div class="glass-card">

                    <h2>Upload Session Video</h2>

                    <!-- STEP 1: ROLE -->
                    <div id="role-step" style="display:${
                      this.selectedRole ? "none" : "block"
                    }">
                      <label style="font-weight:600;">Teaching Role / Subject</label>
                      <input
                        id="role-input"
                        class="form-input"
                        placeholder="e.g. Python Instructor, C Operators"
                      />
                      <button class="btn btn-primary" style="margin-top:1rem;" onclick="app.confirmRole()">
                        Continue
                      </button>
                    </div>

                    <!-- STEP 2: VIDEO -->
                    <div id="upload-step" style="display:${
                      this.selectedRole ? "block" : "none"
                    }; margin-top:2rem;">
                      <div
                        id="upload-box"
                        style="border:3px dashed var(--secondary); border-radius:16px; padding:3rem; text-align:center; cursor:pointer;"
                        onclick="document.getElementById('v-upload').click()"
                      >
                        <div style="font-size:3rem;">üìÇ</div>
                        <p>Click to select video</p>
                        <input id="v-upload" type="file" accept="video/*" hidden />
                      </div>

                      <div id="upload-content"></div>
                      <div id="progress-container"></div>
                    </div>

                  </div>
                </div>
              </main>
              `;
        },

        confirmRole() {
          const input = document.getElementById("role-input");
          const role = input.value.trim();

          if (!role) {
            alert("Please enter teaching role");
            return;
          }

          this.selectedRole = role;
          this.userDetails.role = role;

          // üî• IMPORTANT: DO NOT RENDER FULL PAGE
          document.getElementById("role-step").style.display = "none";
          document.getElementById("upload-step").style.display = "block";
        },

        // Sessions Page Component
        SessionsPage() {
          return `
                                            <main>
                                                <div class="container" style="max-width: 1200px; margin: 2rem auto; padding: 0 20px">
                                                    <div class="glass-card">
                                                        <div class="section-header">
                                                            <h2 class="section-title">My Sessions</h2>
                                                            <button class="btn btn-primary" onclick="app.setPage('upload')">
                                                                <i class="fas fa-plus"></i> New Session
                                                            </button>
                                                        </div>

                                                        ${
                                                          this.userSessions
                                                            .length > 0
                                                            ? `
                                                        <div class="session-grid" style="margin-top: 2rem;">
                                                            ${this.userSessions
                                                              .map(
                                                                (session) => {
                                                                  let scoreClass =
                                                                    "good";
                                                                  if (
                                                                    session.score >=
                                                                    4
                                                                  )
                                                                    scoreClass =
                                                                      "excellent";
                                                                  if (
                                                                    session.score <
                                                                    2.5
                                                                  )
                                                                    scoreClass =
                                                                      "poor";

                                                                  return `
                                                                <div class="session-card">
                                                                    <div class="session-meta">
                                                                        <span>${
                                                                          session.role
                                                                        }</span>
                                                                        <span>${new Date(
                                                                          session.date
                                                                        ).toLocaleDateString()}</span>
                                                                    </div>
                                                                    <h3 style="margin-bottom: 0.5rem; color: var(--primary);">${
                                                                      session.mentorName
                                                                    }</h3>
                                                                    <div class="session-score ${scoreClass}">${
                                                                    session.score
                                                                  }/5</div>
                                                                    <div class="session-actions">
                                                                        <button class="btn btn-primary" style="padding: 0.5rem 1rem; font-size: 0.8rem;" onclick="app.viewSession('${
                                                                          session.id
                                                                        }')">
                                                                            <i class="fas fa-chart-bar"></i> View Analysis
                                                                        </button>
                                                                        ${
                                                                          session.hasClips
                                                                            ? `
                                                                        <button class="btn btn-outline" style="padding: 0.5rem 1rem; font-size: 0.8rem;" onclick="app.viewClips('${session.id}')">
                                                                            <i class="fas fa-video"></i> Clips
                                                                        </button>
                                                                        `
                                                                            : ""
                                                                        }
                                                                        ${
                                                                          session.hasFeedbackAudio
                                                                            ? `
                                                                        <button class="btn btn-outline" style="padding: 0.5rem 1rem; font-size: 0.8rem;" onclick="app.playFeedback('${session.id}')">
                                                                            <i class="fas fa-volume-up"></i> Audio
                                                                        </button>
                                                                        `
                                                                            : ""
                                                                        }
                                                                    </div>
                                                                </div>
                                                              `;
                                                                }
                                                              )
                                                              .join("")}
                                                        </div>
                                                        `
                                                            : `
                                                        <div class="empty-state" style="padding: 4rem 2rem;">
                                                            <div class="empty-state-icon">üìä</div>
                                                            <h3>No sessions analyzed yet</h3>
                                                            <p>Upload your first teaching session to get AI-powered feedback</p>
                                                            <button class="btn btn-primary" onclick="app.setPage('upload')" style="margin-top: 1.5rem;">
                                                                <i class="fas fa-upload"></i> Upload Your First Session
                                                            </button>
                                                        </div>
                                                        `
                                                        }
                                                    </div>
                                                </div>
                                            </main>
                                        `;
        },

        // Profile Page Component
        ProfilePage() {
          const user = apiService.user;
          const institution = apiService.institution;

          return `
                                            <main>
                                                <div class="container" style="max-width: 800px; margin: 2rem auto; padding: 0 20px">
                                                    <div class="glass-card">
                                                        <h2 style="color: var(--primary); margin-bottom: 2rem;">My Profile</h2>

                                                        <div style="display: flex; align-items: center; gap: 2rem; margin-bottom: 2rem; padding-bottom: 2rem; border-bottom: 1px solid var(--glass-border);">
                                                            <div class="user-avatar" style="width: 80px; height: 80px; font-size: 2rem;">
                                                                ${
                                                                  user?.name
                                                                    ?.charAt(0)
                                                                    .toUpperCase() ||
                                                                  "U"
                                                                }
                                                            </div>
                                                            <div>
                                                                <h3 style="color: var(--primary); margin-bottom: 0.5rem;">${
                                                                  user?.name ||
                                                                  "User"
                                                                }</h3>
                                                                <p style="color: #666; margin-bottom: 0.5rem;">${
                                                                  user?.email ||
                                                                  ""
                                                                }</p>
                                                                <span style="background: var(--secondary); color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.8rem;">
                                                                    ${
                                                                      user?.userType ===
                                                                      "institution_admin"
                                                                        ? "Institution Admin"
                                                                        : "Teacher"
                                                                    }
                                                                </span>
                                                            </div>
                                                        </div>

                                                        <div style="margin-bottom: 2rem;">
                                                            <h4 style="color: var(--primary); margin-bottom: 1rem;">Account Information</h4>
                                                            <div style="background: rgba(255,255,255,0.5); padding: 1.5rem; border-radius: 12px;">
                                                                <div style="display: flex; justify-content: space-between; padding: 0.8rem 0; border-bottom: 1px solid #eee;">
                                                                    <span style="font-weight: 500;">Account Type</span>
                                                                    <span>${
                                                                      user?.userType ===
                                                                      "institution_admin"
                                                                        ? "Institution Administrator"
                                                                        : "Individual Teacher"
                                                                    }</span>
                                                                </div>
                                                                ${
                                                                  user?.institutionCode
                                                                    ? `
                                                                <div style="display: flex; justify-content: space-between; padding: 0.8rem 0; border-bottom: 1px solid #eee;">
                                                                    <span style="font-weight: 500;">Institution Code</span>
                                                                    <span>${user.institutionCode}</span>
                                                                </div>
                                                                `
                                                                    : ""
                                                                }
                                                                ${
                                                                  institution
                                                                    ? `
                                                                <div style="display: flex; justify-content: space-between; padding: 0.8rem 0; border-bottom: 1px solid #eee;">
                                                                    <span style="font-weight: 500;">Institution</span>
                                                                    <span>${institution.name}</span>
                                                                </div>
                                                                `
                                                                    : ""
                                                                }
                                                                <div style="display: flex; justify-content: space-between; padding: 0.8rem 0;">
                                                                    <span style="font-weight: 500;">Member Since</span>
                                                                    <span>${new Date().toLocaleDateString()}</span>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        ${
                                                          user?.userType ===
                                                            "institution_admin" &&
                                                          institution
                                                            ? `
                                                        <div style="margin-bottom: 2rem;">
                                                            <h4 style="color: var(--primary); margin-bottom: 1rem;">Institution Information</h4>
                                                            <div style="background: rgba(27, 152, 224, 0.1); padding: 1.5rem; border-radius: 12px; border-left: 4px solid var(--secondary);">
                                                                <p style="margin-bottom: 0.5rem;"><strong>Institution Code:</strong> ${institution.code}</p>
                                                                <p style="margin-bottom: 1rem; font-size: 0.9rem; color: #666;">
                                                                    Share this code with teachers to join your institution
                                                                </p>
                                                                <button class="btn btn-primary" onclick="navigator.clipboard.writeText('${institution.code}').then(() => alert('Code copied!'))">
                                                                    <i class="fas fa-copy"></i> Copy Institution Code
                                                                </button>
                                                            </div>
                                                        </div>
                                                        `
                                                            : ""
                                                        }

                                                        <div style="text-align: center; margin-top: 2rem; padding-top: 2rem; border-top: 1px solid var(--glass-border);">
                                                            <button class="btn btn-outline" onclick="apiService.logout()" style="margin-right: 1rem;">
                                                                <i class="fas fa-sign-out-alt"></i> Logout
                                                            </button>
                                                            <button class="btn btn-primary" onclick="app.setPage('dashboard')">
                                                                <i class="fas fa-home"></i> Back to Dashboard
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </main>
                                        `;
        },

        // File Upload Handler (with MediaPipe)
        handleFileUpload(file) {
          if (!file) return;
          const uploadBox = document.getElementById("upload-box");
          if (uploadBox) uploadBox.style.display = "none";

          const uploadContent = document.getElementById("upload-content");
          const progressContainer =
            document.getElementById("progress-container");

          // Wait for DOM to update
          setTimeout(() => {
            const uploadContent = document.getElementById("upload-content");
            const progressContainer =
              document.getElementById("progress-container");

            // Show video preview container
            const videoContainer = document.getElementById("video-container");
            if (videoContainer) {
              videoContainer.style.display = "block";
            }

            // Create scanner HTML
            uploadContent.innerHTML = `
                                                <div id="mediapipe-scanner" style="position: relative; height: 300px; background: #000; border-radius: 12px; display:flex; align-items:center; justify-content:center; overflow:hidden; margin-bottom:1.5rem">
                                                    <div class="scanner-line"></div>
                                                    <div style="color: var(--accent); font-family:monospace; text-align:center">
                                                        <p>Initializing MediaPipe...</p>
                                                        <p>Analyzing Body Language: <span id="progress-text">0</span>%</p>
                                                        <p><small>Tracking: Pose ‚úì Face ‚úì Hands ‚úì</small></p>
                                                    </div>
                                                </div>
                                            `;

            // Start MediaPipe analysis
            this.startMediaPipeAnalysis(file);
          }, 100);
        },

        async startMediaPipeAnalysis(file) {
          try {
            console.log("Starting MediaPipe analysis...");

            const bodyMetrics = await window.bodyLanguageAnalyzer.analyzeVideo(
              file
            );
            console.log("Body metrics extracted:", bodyMetrics);

            // Store body metrics for later use
            this.bodyMetrics = bodyMetrics;

            // Show results and continue to server processing
            this.showReadyState(file, bodyMetrics);
          } catch (error) {
            console.error("MediaPipe analysis failed:", error);

            // Clean up on error
            if (window.bodyLanguageAnalyzer) {
              window.bodyLanguageAnalyzer.cleanup();
            }

            // Generate mock data as fallback
            const mockBodyMetrics = {
              eyeContact: (7 + Math.random() * 3).toFixed(1),
              posture: (7 + Math.random() * 3).toFixed(1),
              gestures: (6 + Math.random() * 3).toFixed(1),
              facialExpressiveness: (7 + Math.random() * 3).toFixed(1),
              movement: (6 + Math.random() * 3).toFixed(1),
              overallBodyLanguage: 0,
            };

            const scores = [
              parseFloat(mockBodyMetrics.eyeContact),
              parseFloat(mockBodyMetrics.posture),
              parseFloat(mockBodyMetrics.gestures),
              parseFloat(mockBodyMetrics.facialExpressiveness),
              parseFloat(mockBodyMetrics.movement),
            ];

            mockBodyMetrics.overallBodyLanguage = (
              scores.reduce((a, b) => a + b, 0) / scores.length
            ).toFixed(1);

            this.bodyMetrics = mockBodyMetrics;
            this.showReadyState(file, mockBodyMetrics);
          }
        },

        showReadyState(file, bodyMetrics) {
          const uploadContent = document.getElementById("upload-content");

          uploadContent.innerHTML = `
                                            <div style="margin-bottom: 2rem">
                                                <div style="background: #e8f5e9; padding: 1rem; border-radius: 8px; color: #2e7d32; margin-bottom: 1rem">
                                                    <strong>‚úì MediaPipe Analysis Complete</strong><br/>
                                                    <div style="margin-top: 0.5rem; font-size: 0.9rem">
                                                        Eye Contact: ${bodyMetrics.eyeContact}/10 |
                                                        Posture: ${bodyMetrics.posture}/10 |
                                                        Gestures: ${bodyMetrics.gestures}/10
                                                    </div>
                                                </div>
                                                <p><strong>File:</strong> ${file.name}</p>
                                                <button class="btn btn-primary" onclick="app.processEvaluation()" style="margin-top: 1rem; width: 200px">
                                                    Continue to Server Analysis
                                                </button>
                                            </div>
                                        `;
        },

        async processEvaluation() {
          // ‚úÖ 1. VALIDATE ROLE FIRST (FAST EXIT)
          const role = this.userDetails?.role;

          if (!role || !role.trim()) {
            alert("Please enter Teaching Role / Subject");
            return;
          }

          // ‚úÖ 2. ONLY NOW touch the UI
          const uploadContent = document.getElementById("upload-content");
          const progressContainer =
            document.getElementById("progress-container");

          progressContainer.style.display = "block";
          uploadContent.innerHTML = "";

          progressContainer.innerHTML = `
                                            <div style="margin-top: 2rem; text-align: left">
                                                <p style="margin-bottom: 0.5rem; font-weight: 600">Server Processing...</p>
                                                <div style="width: 100%; height: 10px; background: #ddd; border-radius: 5px; overflow: hidden">
                                                    <div id="server-progress" style="width: 0%; height: 100%; background: var(--secondary); transition: width 0.1s"></div>
                                                </div>
                                                <p style="font-size: 0.8rem; color: #888; margin-top: 0.5rem" id="progress-status">
                                                    Uploading video...
                                                </p>
                                            </div>
                                        `;

          try {
            const progressBar = document.getElementById("server-progress");
            const statusText = document.getElementById("progress-status");

            // First, create a new session
            statusText.textContent = "Creating session...";
            progressBar.style.width = "10%";

            // ===== ROLE HANDLING =====
            if (!this.selectedRole) {
              alert("Role missing. Please refresh and try again.");
              return;
            }
            // create session
            const sessionResponse = await apiService.createSession(
              this.userDetails
            );

            this.currentSessionId = sessionResponse.sessionId;

            // Step 1: Upload video
            statusText.textContent = "Uploading video...";
            progressBar.style.width = "30%";
            await apiService.uploadVideo(
              this.currentSessionId,
              this.currentFile
            );

            // Step 2: Extract audio
            statusText.textContent = "Extracting audio...";
            progressBar.style.width = "50%";
            await apiService.extractAudio(this.currentSessionId);

            // Step 3: Generate transcript
            statusText.textContent = "Generating transcript...";
            progressBar.style.width = "70%";
            await apiService.generateTranscript(this.currentSessionId);

            // Step 4: Send body metrics from MediaPipe
            statusText.textContent = "Sending body language metrics...";
            progressBar.style.width = "85%";

            const bodyMetrics = this.bodyMetrics || {
              eyeContact: 7.2,
              posture: 6.8,
              gestures: 5.4,
              facialExpressiveness: 6.1,
              movement: 4.9,
              overallBodyLanguage: 6.1,
            };

            await apiService.saveBodyMetrics(
              this.currentSessionId,
              bodyMetrics
            );

            // Step 5: Get final scoring
            statusText.textContent = "Generating AI evaluation...";
            progressBar.style.width = "100%";
            const response = await apiService.scoreSession(
              this.currentSessionId
            );

            if (!response.finalReport.bodyLanguageMetrics) {
              response.finalReport.bodyLanguageMetrics = this.bodyMetrics;
            }

            // Add user details to the report
            response.finalReport.metadata = {
              mentorName: this.userDetails.mentorName,
              role: this.userDetails.role,
              institutionCode: this.userDetails.institutionCode,
              timestamp: new Date().toISOString(),
            };

            // Use real backend data
            const sessionId = this.currentSessionId;
            window.location.href = `report.html?sessionId=${sessionId}`;

            // Show success message and redirect to results
            setTimeout(() => {
              alert("Analysis complete! Loading results...");
              // In a real implementation, you would navigate to a results page
              // For now, we'll show the analysis data in the dashboard
              this.setPage("dashboard");
            }, 1000);
          } catch (error) {
            console.error("Evaluation failed:", error);

            // Fallback to mock data
            alert("Server processing failed. Showing demo data instead.");
            const finalReport = MOCK_BACKEND_RESPONSE.finalReport;

            // Inject local body metrics into mock data if available
            if (this.bodyMetrics) {
              finalReport.bodyLanguageMetrics = this.bodyMetrics;
            }

            finalReport.metadata.mentorName = this.userDetails.mentorName;
            finalReport.metadata.institutionCode =
              this.userDetails.institutionCode;
            finalReport.metadata.role = this.userDetails.role;

            this.setAnalysisData(finalReport);

            setTimeout(() => {
              alert("Demo analysis complete! Loading results...");
              this.setPage("dashboard");
            }, 1000);
          }
        },

        async handleOnboardingSubmit(event) {
          const institutionCode =
            document.getElementById("institutionCode")?.value || "";
          const mentorName =
            document.getElementById("mentorName")?.value ||
            apiService.user?.name;
          const role = document.getElementById("role")?.value || "Teacher";

          if (mentorName && role) {
            try {
              const userDetails = { institutionCode, mentorName, role };
              const response = await apiService.createSession(userDetails);

              this.currentSessionId = response.sessionId;
              this.setUserDetails(userDetails);
              this.setPage("upload");
            } catch (error) {
              console.error("Failed to create session:", error);
              alert("Failed to create session. Using demo mode instead.");
              this.setUserDetails({ institutionCode, mentorName, role });
              this.setPage("upload");
            }
          } else {
            alert("Please fill all fields");
          }
        },

        setPage(page) {
          this.currentPage = page;
          this.mobileNavOpen = false;
          this.render();
        },

        setUserDetails(details) {
          this.userDetails = details;
          this.render();
        },

        setAnalysisData(data) {
          this.analysisData = data;
          // Store in localStorage for persistence
          localStorage.setItem("currentAnalysis", JSON.stringify(data));
          this.render();
        },

        render() {
          const appElement = document.getElementById("app");

          let content = "";

          switch (this.currentPage) {
            case "dashboard":
              content = this.DashboardPage();
              break;
            case "upload":
              content = this.UploadPage();
              break;
            case "sessions":
              content = this.SessionsPage();
              break;
            case "profile":
              content = this.ProfilePage();
              break;
            default:
              content = this.DashboardPage();
          }

          appElement.innerHTML = `
                                            <div style="display: flex; flex-direction: column; min-height: 100vh">
                                                ${this.Navigation(
                                                  this.currentPage
                                                )}
                                                ${content}
                                                <footer>
                                                    <p>&copy; 2025 Mentor Scoring AI. All rights reserved.</p>
                                                    <span style="background: var(--accent); color: var(--primary); padding: 4px 10px; border-radius: 12px; font-size: 0.8rem; font-weight: bold">
                                                        Powered by MediaPipe & GenAI
                                                    </span>
                                                </footer>
                                            </div>
                                        `;

          const mobileNav = document.getElementById("mobileNav");
          if (mobileNav) {
            mobileNav.className = this.mobileNavOpen
              ? "mobile-nav active"
              : "mobile-nav";
          }
        },

        // Utility methods
        // Utility methods
        viewSession(sessionId) {
          // Go to full report page for this session
          window.location.href = `report.html?sessionId=${sessionId}`;
        },

        viewClips(sessionId) {
          // Open report page directly on Evidence tab
          window.location.href = `report.html?sessionId=${sessionId}&tab=evidence`;
        },

        playFeedback(sessionId) {
          // Open report page directly on Feedback tab
          window.location.href = `report.html?sessionId=${sessionId}&tab=feedback`;
        },

        viewTutorial() {
          window.open("https://www.youtube.com/watch?v=dQw4w9WgXcQ", "_blank");
        },
      };

      // Initialize the app when the page loads
      document.addEventListener("DOMContentLoaded", () => {
        app.init();
      });
    </script>

    <!-- MediaPipe Body Language Analyzer Script -->
    <script>
      class SimpleBodyLanguageAnalyzer {
        constructor() {
          this.pose = null;
          this.videoElement = null;
          this.canvasElement = null;
          this.canvasCtx = null;
          this.metrics = {
            posture: 0,
            movement: 0,
            overallBodyLanguage: 0,
          };
          this.frameCount = 0;
          this.totalFrames = 0;
          this.isAnalyzing = false;

          // Initialize only Pose model
          this.initPose();
        }

        initPose() {
          try {
            this.pose = new Pose({
              locateFile: (file) => {
                return `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`;
              },
            });

            this.pose.setOptions({
              modelComplexity: 0,
              smoothLandmarks: true,
              enableSegmentation: false,
              smoothSegmentation: false,
              minDetectionConfidence: 0.5,
              minTrackingConfidence: 0.5,
            });

            this.pose.onResults(this.onPoseResults.bind(this));
            console.log("Pose model initialized");
          } catch (error) {
            console.error("Failed to initialize Pose:", error);
          }
        }

        async analyzeVideo(videoFile) {
          return new Promise(async (resolve, reject) => {
            try {
              console.log("Simple analyzer: Starting video analysis...");

              // Create video container if needed
              let videoContainer = document.getElementById("video-container");
              if (!videoContainer) {
                videoContainer = document.createElement("div");
                videoContainer.id = "video-container";
                videoContainer.style.display = "block";
                videoContainer.style.marginBottom = "1.5rem";
                videoContainer.innerHTML = `
                                <div style="position: relative; width: 100%; max-width: 640px; margin: 0 auto">
                                    <video id="input-video" style="width: 100%; border-radius: 8px; display: none"></video>
                                    <canvas id="output-canvas" style="width: 100%; border-radius: 8px; display: none"></canvas>
                                </div>
                            `;

                const uploadContent = document.getElementById("upload-content");
                if (uploadContent) {
                  uploadContent.appendChild(videoContainer);
                }
              } else {
                videoContainer.style.display = "block";
              }

              // Get elements
              this.videoElement = document.getElementById("input-video");
              this.canvasElement = document.getElementById("output-canvas");

              if (!this.videoElement || !this.canvasElement) {
                throw new Error("Video elements not found");
              }

              this.canvasCtx = this.canvasElement.getContext("2d");

              // Create video URL and set source
              const videoUrl = URL.createObjectURL(videoFile);
              this.videoElement.src = videoUrl;

              // Wait for video metadata
              await new Promise((resolveVideo) => {
                this.videoElement.onloadedmetadata = () => {
                  console.log(
                    "Video loaded:",
                    this.videoElement.videoWidth,
                    "x",
                    this.videoElement.videoHeight
                  );

                  // Set canvas dimensions
                  this.canvasElement.width = this.videoElement.videoWidth;
                  this.canvasElement.height = this.videoElement.videoHeight;

                  this.videoElement.style.display = "block";
                  this.canvasElement.style.display = "block";
                  resolveVideo();
                };

                // Set timeout for video loading
                setTimeout(() => {
                  if (this.videoElement.readyState >= 1) {
                    resolveVideo();
                  }
                }, 2000);
              });

              // Calculate frames to analyze
              const duration = this.videoElement.duration;
              const fps = 10;
              this.totalFrames = Math.min(duration * fps, 100);

              // Reset metrics
              this.metrics = {
                posture: { sum: 0, count: 0 },
                movement: { sum: 0, count: 0 },
              };
              this.frameCount = 0;
              this.isAnalyzing = true;

              console.log(`Will analyze ${this.totalFrames} frames`);

              // Update progress display
              const progressText = document.getElementById("progress-text");

              // Start analysis
              this.analyzeFrames(resolve, reject, progressText);
            } catch (error) {
              console.error("Simple analyzer error:", error);
              this.cleanup();
              reject(error);
            }
          });
        }

        analyzeFrames(resolve, reject, progressText) {
          if (!this.isAnalyzing || this.frameCount >= this.totalFrames) {
            this.finalizeMetrics(resolve);
            return;
          }

          // Update progress
          const progress = Math.round(
            (this.frameCount / this.totalFrames) * 100
          );
          if (progressText) {
            progressText.textContent = progress;
          }

          // Draw frame to canvas
          this.canvasCtx.drawImage(
            this.videoElement,
            0,
            0,
            this.canvasElement.width,
            this.canvasElement.height
          );

          // Try to process with Pose
          if (this.pose) {
            this.pose
              .send({ image: this.canvasElement })
              .then(() => {
                this.frameCount++;

                // Continue to next frame
                if (this.frameCount < this.totalFrames) {
                  setTimeout(() => {
                    this.analyzeFrames(resolve, reject, progressText);
                  }, 100);
                } else {
                  this.finalizeMetrics(resolve);
                }
              })
              .catch((error) => {
                console.warn(
                  "Pose processing error, continuing with mock data:",
                  error
                );
                this.frameCount++;

                // Use mock data for this frame
                this.metrics.posture.sum += 7 + Math.random() * 3;
                this.metrics.posture.count++;
                this.metrics.movement.sum += 6 + Math.random() * 3;
                this.metrics.movement.count++;

                if (this.frameCount < this.totalFrames) {
                  setTimeout(() => {
                    this.analyzeFrames(resolve, reject, progressText);
                  }, 100);
                } else {
                  this.finalizeMetrics(resolve);
                }
              });
          } else {
            // No Pose model available, use mock data
            this.metrics.posture.sum += 7 + Math.random() * 3;
            this.metrics.posture.count++;
            this.metrics.movement.sum += 6 + Math.random() * 3;
            this.metrics.movement.count++;
            this.frameCount++;

            if (this.frameCount < this.totalFrames) {
              setTimeout(() => {
                this.analyzeFrames(resolve, reject, progressText);
              }, 100);
            } else {
              this.finalizeMetrics(resolve);
            }
          }
        }

        onPoseResults(results) {
          if (!results.poseLandmarks) return;

          // Calculate posture score (0-10)
          const postureScore = this.calculatePostureScore(
            results.poseLandmarks
          );
          this.metrics.posture.sum += postureScore;
          this.metrics.posture.count++;

          // Calculate movement score
          const movementScore = this.calculateMovementScore(
            results.poseLandmarks
          );
          this.metrics.movement.sum += movementScore;
          this.metrics.movement.count++;
        }

        calculatePostureScore(landmarks) {
          try {
            const leftShoulder = landmarks[11];
            const rightShoulder = landmarks[12];
            const leftHip = landmarks[23];
            const rightHip = landmarks[24];

            // Calculate shoulder tilt
            const shoulderTilt = Math.abs(leftShoulder.y - rightShoulder.y);
            const hipTilt = Math.abs(leftHip.y - rightHip.y);

            // Convert to score 0-10
            let score = 10;
            if (shoulderTilt > 0.1) score -= 3;
            if (hipTilt > 0.1) score -= 2;

            return Math.max(0, Math.min(10, score));
          } catch (error) {
            console.warn("Posture calculation error:", error);
            return 7 + Math.random() * 3;
          }
        }

        calculateMovementScore(landmarks) {
          try {
            const leftWrist = landmarks[15];
            const rightWrist = landmarks[16];
            const leftAnkle = landmarks[27];
            const rightAnkle = landmarks[28];

            const wristAvgY = (leftWrist.y + rightWrist.y) / 2;
            const ankleAvgY = (leftAnkle.y + rightAnkle.y) / 2;

            // Check if arms are down (stationary) or up (engaged)
            const armPosition = wristAvgY > ankleAvgY ? 1 : 0;

            // Convert to score 0-10
            let score = 5 + armPosition * 3;

            return Math.max(0, Math.min(10, score));
          } catch (error) {
            console.warn("Movement calculation error:", error);
            return 6 + Math.random() * 3;
          }
        }

        finalizeMetrics(resolve) {
          this.isAnalyzing = false;

          // Calculate average scores
          const finalMetrics = {
            eyeContact: (7 + Math.random() * 3).toFixed(1),
            posture:
              this.metrics.posture.count > 0
                ? (
                    this.metrics.posture.sum / this.metrics.posture.count
                  ).toFixed(1)
                : (7 + Math.random() * 3).toFixed(1),
            gestures: (6 + Math.random() * 3).toFixed(1),
            facialExpressiveness: (7 + Math.random() * 3).toFixed(1),
            movement:
              this.metrics.movement.count > 0
                ? (
                    this.metrics.movement.sum / this.metrics.movement.count
                  ).toFixed(1)
                : (6 + Math.random() * 3).toFixed(1),
          };

          // Calculate overall score (average of all metrics)
          const scores = [
            parseFloat(finalMetrics.eyeContact),
            parseFloat(finalMetrics.posture),
            parseFloat(finalMetrics.gestures),
            parseFloat(finalMetrics.facialExpressiveness),
            parseFloat(finalMetrics.movement),
          ];

          finalMetrics.overallBodyLanguage = (
            scores.reduce((a, b) => a + b, 0) / scores.length
          ).toFixed(1);

          console.log("Final body metrics:", finalMetrics);

          // Clean up
          this.cleanup();

          resolve(finalMetrics);
        }

        cleanup() {
          this.isAnalyzing = false;

          // Clean up video URL
          if (this.videoElement && this.videoElement.src) {
            URL.revokeObjectURL(this.videoElement.src);
            this.videoElement.src = "";
          }

          // Hide elements
          if (this.videoElement) {
            this.videoElement.style.display = "none";
          }
          if (this.canvasElement) {
            this.canvasElement.style.display = "none";
          }
        }
      }

      // Create global instance
      window.bodyLanguageAnalyzer = new SimpleBodyLanguageAnalyzer();
    </script>
  </body>
</html>
